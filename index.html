<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gems of Bergen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <nav class="navbar">
    <div class="nav-left">
      <p id="comp-name"><a href="index.html">Gems of Bergen</a></p>
    </div>

    <div class="language-switcher">
      <select id="language-select">
        <option class="language" value="EN">EN</option>
        <option class="language" value="NO">NO</option>
      </select>
    </div>

    <div class="nav-center">
      <input type="text" id="destination-search" placeholder="Search for destinations...">
      <div id="suggestions" class="suggestions-list"></div>
    </div>

    <div class="nav-right">
      <a id="explore-link" href="index.html">Explore</a>
      <a id="reviews-link" href="reviews.html">Rating</a>
      <a id="about-link" href="about.html">About</a>
      <a id="contact-link" href="#">Contact</a>
      <div id="cart-icon">üõí <span id="cart-count">0</span></div>
    </div>

    <div class="menu-toggle" id="menu-toggle">‚ò∞</div>
  </nav>
</header>


  <section class="hero">
    <div class="hero-image">
      <div class="hero-text" id="hero-text">
        <h1 id="bergen">Bergen</h1>
        <p>Choose your dream tour and experience hidden gems, and the very best that Bergen has to offer.</p>
      </div>
    </div>
  </section>

  <section class="gallery">
    <div class="gallery-container">
      <div class="gallery-item">
        <img src="pics/ulriken.jpg" alt="trollskogen">
        <div id="trollskogen" class="tour-info">
          <h3>Trip to ‚Äútrollskogen‚Äù at fl√∏yen</h3>
          <p>Join us on a trip to Mount Fl√∏yen, <br>
            one of Bergen‚Äôs most famous attractions. <br>
            At the top, you‚Äôll find a mysterious troll forest<br>
            ‚Äî the perfect spot for taking photos.</p>
           <p>Here, you‚Äôll also get to learn about <br>
            Norwegian folklore, including tales<br>
           of trolls and other traditional myths. </p>
          <button class="button">Order</button>
          <div id="rating" class="rating-summary">
            <small>Rating: <span class="avg" data-tour="ulriken">‚Äì</span> ‚òÖ (<span class="count" data-tour="ulriken">0</span>)</small>
          </div>
          <button class="button feedback-btn" data-tour="ulriken" data-tour-title="Ulriken Tour">Rate & comments</button>
        </div>
      </div>

    <div class="gallery-item">
        <img src="pics/fl√∏yen.jpg" alt="Bergen fl√∏yen">
          <div id="cinnamun" class="tour-info">
            <h3>Cinnamun bun tour</h3>
            <p>Scandinavia is famous for its delicious<br>
               sweet buns ‚Äî and here in Bergen, <br>
               we take great pride in ours!</p>
                <p>Join our bun tour, where we visit<br>
                 several authentic caf√©s to taste <br>
                 real Norwegian buns. Warm, fresh,<br>
                and traditional, packed with butter and<br>
                 sugar ‚Äî just the way they should be.<br>
                </p>
            <button class="button">Order</button>
            <div class="rating-summary">
              <small>Rating: <span class="avg" data-tour="floyen">‚Äì</span> ‚òÖ (<span class="count" data-tour="floyen">0</span>)</small>
            </div>
            <button class="button feedback-btn" data-tour="floyen" data-tour-title="Fl√∏yen Tour">Rate & comments</button>
          </div>
    </div>

      <div class="gallery-item">
        <img src="pics/nordnesparken.jpg" alt="Bergen park">
      <div class="tour-info">
       <h3>Nordnes Park Tour</h3>
        <p>Discover the beauty of Nordnes Park<br>
          with its gardens and waterfront views.</p>
        <button class="button">Order</button>
        <div class="rating-summary">
          <small>Rating: <span class="avg" data-tour="nordnes">‚Äì</span> ‚òÖ (<span class="count" data-tour="nordnes">0</span>)</small>
        </div>
        <button class="button feedback-btn" data-tour="nordnes" data-tour-title="Nordnes Park Tour">Rate & comments</button>
      </div>
    </div>

      <div class="gallery-item">
        <img src="pics/sentrum.jpg" alt="Bergen city senter">
      <div class="tour-info">
       <h3>Bergen City Center Tour</h3>
        <p>Explore the historic city center<br>
          with its charming streets and shops.</p>
        <button class="button">Order</button>
        <div class="rating-summary">
          <small>Rating: <span class="avg" data-tour="citycenter">‚Äì</span> ‚òÖ (<span class="count" data-tour="citycenter">0</span>)</small>
        </div>
        <button class="button feedback-btn" data-tour="citycenter" data-tour-title="Bergen City Center Tour">Rate & comments</button>
      </div>
    </div>

      <div class="gallery-item">
        <img src="pics/bryggen.jpg" alt="Bergen fish market">
      <div class="tour-info">
       <h3>Bryggen and Fish Market Tour</h3>
        <p>Visit the iconic Bryggen wharf<br>
          and experience the vibrant fish market.</p>
        <button class="button">Order</button>
        <div class="rating-summary">
          <small>Rating: <span class="avg" data-tour="bryggen">‚Äì</span> ‚òÖ (<span class="count" data-tour="bryggen">0</span>)</small>
        </div>
        <button class="button feedback-btn" data-tour="bryggen" data-tour-title="Bryggen and Fish Market Tour">Rate & comments</button>
      </div>
    </div>

      <div class="gallery-item">
        <img src="pics/bergen.jpg" alt="Bergen aquarium">
      <div class="tour-info">
       <h3>Bergen Aquarium Tour</h3>
        <p>Explore the fascinating marine life<br>
          at the Bergen Aquarium.</p>
        <button class="button">Order</button>
        <div class="rating-summary">
          <small>Rating: <span class="avg" data-tour="aquarium">‚Äì</span> ‚òÖ (<span class="count" data-tour="aquarium">0</span>)</small>
        </div>
        <button class="button feedback-btn" data-tour="aquarium" data-tour-title="Bergen Aquarium Tour">Rate & comments</button>
      </div>
    </div>
  </section>

  <section class="bottom-banner">
    <img class="bottom-banner-img" src="pics/bryggen.jpg" alt="Bergen Bryggen">
    <div class="banner-lay">
        <div class="banner-text">
          <ul>
            <li><a id="ContactFooter" href="#">Contact</a></li>
            <li><a id="about-bottom-link" href="about.html">About us</a></li>
            <li><a id="apply-btn" href="#">Apply for a Job</a></li>
          </ul>
        </div>
    </div>
  </section>

  <div id="cart-modal" class="cart-modal">
    <div class="cart-content">
      <span id="close-cart">&times;</span>
      <h2>Your Tours</h2>
      <ul id="cart-items"></ul>
      <button id="checkout-btn" class="button">Checkout</button>
    </div>
  </div>
  
<div id="contact-modal" class="modal">
  <div class="modal-content">
    <span id="close-contact" class="close">&times;</span>
    <h2>Contact Us</h2>
    <p><strong>Email:</strong> tourguide@company.com</p>
    <p><strong>Phone:</strong> +47 123 456 789</p>
    <hr>
    <h3>Leave a Request</h3>
    <form action="https://formspree.io/f/mnnodrld" method="POST" id="contact-form">
      <input type="text" name="name" placeholder="Your Name" required>
      <input type="email" name="email" placeholder="Your Email" required>
      <textarea name="message" placeholder="Your Message" required></textarea>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<div id="apply-modal" class="modal">
  <div class="modal-content">
    <span id="close-apply" class="close">&times;</span>
    <h2>Work with TourGuide</h2>

    <h3>Available Positions</h3>
    <ul class="vacancy-list">
      <li>
        <strong>Tour Guide</strong>
        <p>Lead visitors through Bergen‚Äôs most stunning routes.</p>
        <p><strong>Contact:</strong> hr@tourguide.com</p>
      </li>
      <li>
        <strong>Customer Support Assistant</strong>
        <p>Help travelers find their next adventure.</p>
        <p><strong>Contact:</strong> jobs@tourguide.com</p>
      </li>
      <li>
        <strong>Photographer</strong>
        <p>Capture magical moments of our tours.</p>
        <p><strong>Contact:</strong> media@tourguide.com</p>
      </li>
    </ul>

    <hr>
      <h3>Contact for Job Applications</h3>
      <p><strong>Email:</strong> hr@tourguide.com</p>
      <p><strong>Phone:</strong> +47 987 654 321</p>
      <p><strong>Office address:</strong> Bergen, Bryggen 12</p>

  </div>
</div>

<!-- Feedback modal -->
<div id="feedback-modal" class="modal">
  <div class="modal-content">
    <span id="close-feedback" class="close">&times;</span>
    <h2 id="feedback-title">Rate & Comment</h2>

    <div id="star-picker" class="stars" style="font-size: 1.4rem; line-height: 1; margin-bottom: 10px;">
      <!-- stars will be injected by JS -->
    </div>

    <form id="feedback-form">
      <input type="text" id="fb-name" placeholder="Your name (optional)">
      <textarea id="fb-text" placeholder="Write a comment..." required></textarea>
      <button type="submit" class="button">Submit</button>
    </form>

    <hr>
    <h3 style="margin-top: 10px;">Recent comments</h3>
    <ul id="comments-list"></ul>
  </div>
</div>

<script src="script.js"></script>
<script src="i18n.js"></script>


<script>
  const contactBtn = document.getElementById('Contact');
  const contactBtnFooter = document.getElementById('ContactFooter');
  const contactModal = document.getElementById('contact-modal');
  const closeContact = document.getElementById('close-contact');
  const contactForm = document.getElementById('contact-form');

  function openContactModal(e) {
    e.preventDefault();
    contactModal.style.display = 'flex';
  }

  if (contactBtn) contactBtn.addEventListener('click', openContactModal);
  if (contactBtnFooter) contactBtnFooter.addEventListener('click', openContactModal);

  closeContact.addEventListener('click', () => {
    contactModal.style.display = 'none';
  });

  window.addEventListener('click', (e) => {
    if (e.target === contactModal) contactModal.style.display = 'none';
  });

const applyBtn = document.getElementById('apply-btn');
const applyModal = document.getElementById('apply-modal');
const closeApply = document.getElementById('close-apply');

applyBtn.addEventListener('click', (e) => {
  e.preventDefault();
  applyModal.style.display = 'flex';
});

closeApply.addEventListener('click', () => {
  applyModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
  if (e.target === applyModal) applyModal.style.display = 'none';
});

// FEEDBACK
const feedbackModal = document.getElementById('feedback-modal');
const closeFeedback  = document.getElementById('close-feedback');
const feedbackTitle  = document.getElementById('feedback-title');
const starPicker     = document.getElementById('star-picker');
const feedbackForm   = document.getElementById('feedback-form');
const fbName         = document.getElementById('fb-name');
const fbText         = document.getElementById('fb-text');
const commentsList   = document.getElementById('comments-list');

let currentTourKey = null;
let currentStars = 0;
starPicker.dataset.selected = '0';

function drawStars() {
  starPicker.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const s = document.createElement('span');
    s.className = 'star';
    s.dataset.value = String(i);
    s.textContent = '‚òÜ';
    s.style.cursor = 'pointer';
    starPicker.appendChild(s);
  }
  syncStars(0);
}

function syncStars(hover = 0) {
  const active = hover || currentStars;
  starPicker.querySelectorAll('.star').forEach(el => {
    const v = Number(el.dataset.value);
    el.textContent = v <= active ? '‚òÖ' : '‚òÜ';
  });
}

starPicker.addEventListener('mousemove', (e) => {
  const s = e.target.closest('.star');
  syncStars(s ? Number(s.dataset.value) : 0);
});

starPicker.addEventListener('mouseleave', () => {
  syncStars(0);
});

starPicker.addEventListener('click', (e) => {
  const s = e.target.closest('.star');
  if (!s) return;
  currentStars = Number(s.dataset.value);
  starPicker.dataset.selected = String(currentStars);
  syncStars(0);
});

starPicker.addEventListener('touchstart', (e) => {
  const s = e.target.closest('.star');
  if (!s) return;
  e.preventDefault();
  currentStars = Number(s.dataset.value);
  starPicker.dataset.selected = String(currentStars);
  syncStars(0);
}, { passive: false });

// API
async function apiGetReviews(tour) {
  const res = await fetch(`https://tourguide-4wz1.onrender.com/api/reviews/${tour}`);
  return res.json();
}
async function apiPostReview(tour_key, user_name, comment, stars) {
  const res = await fetch('https://tourguide-4wz1.onrender.com/api/reviews', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ tour_key, user_name, comment, stars })
  });
  return res.json();
}

function escapeHtml(str) {
  return (str || '').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
}

async function renderComments(tour) {
  commentsList.innerHTML = 'Loading reviews...';
  try {
    const rows = await apiGetReviews(tour);
    commentsList.innerHTML = '';
    if (!rows.length) {
      const li = document.createElement('li');
      li.textContent = 'No comments yet ‚Äî be the first!';
      commentsList.appendChild(li);
      return;
    }
    for (const c of rows) {
      const li = document.createElement('li');
      const who = (c.user_name && c.user_name.trim()) ? c.user_name.trim() : 'Anonymous';
      li.innerHTML = `<strong>${who}</strong> ‚Äî ${'‚òÖ'.repeat(c.stars)}${'‚òÜ'.repeat(5-c.stars)}<br>${escapeHtml(c.comment)}`;
      li.style.marginBottom = '8px';
      commentsList.appendChild(li);
    }
  } catch (e) {
    commentsList.innerHTML = 'Failed to load reviews.';
    console.error(e);
  }
}

async function updateSummary(tour) {
  try {
    const rows = await apiGetReviews(tour);
    const cntEl = document.querySelector(`.count[data-tour="${tour}"]`);
    const avgEl = document.querySelector(`.avg[data-tour="${tour}"]`);
    if (cntEl) cntEl.textContent = rows.length;
    if (avgEl) {
      if (!rows.length) { avgEl.textContent = '‚Äì'; return; }
      const avg = rows.reduce((s, r) => s + (r.stars ?? 5), 0) / rows.length;
      avgEl.textContent = avg.toFixed(1);
    }
  } catch (e) {
    console.error(e);
  }
}

document.querySelectorAll('.feedback-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    const tour  = btn.dataset.tour;
    const title = btn.dataset.tourTitle || 'Rate & Comment';
    currentTourKey = tour;
    feedbackTitle.textContent = title;

    fbName.value = '';
    fbText.value = '';
    currentStars = 0;
    starPicker.dataset.selected = '0';
    syncStars(0);

    renderComments(tour);
    feedbackModal.style.display = 'flex';
  });
});

closeFeedback.addEventListener('click', () => feedbackModal.style.display = 'none');
window.addEventListener('click', (e) => { if (e.target === feedbackModal) feedbackModal.style.display = 'none'; });

feedbackForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const selected = Number(starPicker.dataset.selected || currentStars || 0);
  if (!selected) {
    alert("Please select a star rating!");
    return;
  }
  if (!currentTourKey) return;

  const text  = fbText.value.trim();
  const name  = fbName.value.trim();
  if (!text) return;

  try {
    await apiPostReview(currentTourKey, name, text, Math.max(1, Math.min(5, selected)));
    fbText.value = '';
    currentStars = 0;
    starPicker.dataset.selected = '0';
    syncStars(0);
    await renderComments(currentTourKey);
    await updateSummary(currentTourKey);
    alert('Thanks for your feedback!');
  } catch (e2) {
    alert('Failed to submit review');
    console.error(e2);
  }
});

drawStars();
async function initRatings() {
  for (const t of ['ulriken','floyen','nordnes','citycenter','bryggen','aquarium']) {
    await updateSummary(t);
  }
  const p = new URLSearchParams(location.search);
  const t = p.get('review');
  if (t) {
    const btn = document.querySelector(`.feedback-btn[data-tour="${t}"]`);
    if (btn) btn.click();
  }
}
initRatings();
</script>

</body>
</html>