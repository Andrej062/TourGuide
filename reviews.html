<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reviews â€” TourGuide</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0;
    }
    .toolbar input,
    .toolbar select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .review-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 16px;
      margin: 12px 0;
    }
    .tour-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .stars {
      font-size: 1rem;
    }
    .muted {
      opacity: 0.7;
    }
    .comment {
      border-top: 1px dashed #eee;
      padding-top: 8px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="nav-left">
      <p id="comp-name"><a href="index.html">Gems of Bergen</a></p>
    </div>

    <div class="language-switcher">
      <select id="language-select">
        <option class="language" value="EN">EN</option>
        <option class="language" value="NO">NO</option>
      </select>
    </div>

    <div class="nav-center">
      <input type="text" id="destination-search" placeholder="Destination?">
      <div id="suggestions" class="suggestions-list"></div>
    </div>

    <div class="nav-right">
      <a id="explore-link" href="index.html">Explore</a>
      <a id="reviews-link" href="reviews.html" class="active">Rating</a>
      <a id="about-link" href="about.html">About</a>
      <a id="contact-link" href="#">Contact</a>
      <div id="cart-icon">ðŸ›’ <span id="cart-count">0</span></div>
    </div>

    <div class="menu-toggle" id="menu-toggle">â˜°</div>
  </nav>
</header>

<main class="container">
  <h1>All Reviews</h1>
  <p class="muted">
    Browse ratings and comments from all tours. To leave a new review, open a tour on the main page and click
    <em>Rate &amp; comments</em>.
  </p>

  <div class="toolbar">
    <label>
      Tour:
      <select id="filter-tour">
        <option value="all">All tours</option>
        <option value="ulriken">Ulriken Tour</option>
        <option value="floyen">FlÃ¸yen Tour</option>
        <option value="nordnes">Nordnes Park Tour</option>
        <option value="citycenter">Bergen City Center Tour</option>
        <option value="bryggen">Bryggen and Fish Market Tour</option>
        <option value="aquarium">Bergen Aquarium Tour</option>
      </select>
    </label>

    <label>
      Sort by:
      <select id="sort-by">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="rating_desc">Highest rating</option>
        <option value="rating_asc">Lowest rating</option>
      </select>
    </label>

    <input id="search" type="text" placeholder="Search comments..." />
  </div>

  <div id="reviews-list"></div>
</main>

<div id="contact-modal" class="modal">
  <div class="modal-content">
    <span id="close-contact" class="close">&times;</span>
    <h2>Contact Us</h2>
    <p><strong>Email:</strong> tourguide@company.com</p>
    <p><strong>Phone:</strong> +47 123 456 789</p>
    <hr>
    <h3>Leave a Request</h3>
    <form action="https://formspree.io/f/mnnodrld" method="POST" id="contact-form">
      <input type="text" name="name" placeholder="Your Name" required>
      <input type="email" name="email" placeholder="Your Email" required>
      <textarea name="message" placeholder="Your Message" required></textarea>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<div id="cart-modal" class="cart-modal">
  <div class="cart-content">
    <span id="close-cart">&times;</span>
    <h2>Your Tours</h2>
    <ul id="cart-items"></ul>
    <button id="checkout-btn" class="button">Checkout</button>
  </div>
</div>

<script src="script.js"></script>
<script src="i18n.js"></script>

<script>

  const TOURS = {
    trollskogen: 'Ulriken Tour',
    cinnamunBun: 'FlÃ¸yen Tour',
    shopTour: 'Nordnes Park Tour',
    brownCheese: 'Bergen City Center Tour',
    streetArt: 'Bryggen and Fish Market Tour',
    instagramTour: 'Bergen Aquarium Tour'
  };

  const filterTour = document.getElementById('filter-tour');
  const sortBy = document.getElementById('sort-by');
  const search = document.getElementById('search');
  const list = document.getElementById('reviews-list');

  async function apiGetReviews(tour) {
    const res = await fetch(`https://tourguide-4wz1.onrender.com/api/reviews/${tour}`);
    return res.json();
  }

  async function loadAllReviews() {
    const all = [];
    for (const key of Object.keys(TOURS)) {
      const items = await apiGetReviews(key);
      for (const r of items) {
        all.push({ ...r, title: TOURS[key] });
      }
    }
    return all;
  }

  function escapeHtml(str) {
    return (str || '').replace(/[&<>"]/g, s => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;'
    }[s]));
  }

  let cachedReviews = [];

async function apiDeleteReview(id) {
  const res = await fetch(`https://tourguide-4wz1.onrender.com/api/reviews/${id}`, {
    method: 'DELETE'
  });
  return res.json();
}

  function renderReviews() {
    const tourFilter = filterTour.value;
    const q = (search.value || '').toLowerCase();
    const sort = sortBy.value;

    let rows = [...cachedReviews];

    if (tourFilter !== 'all') {
      rows = rows.filter(r => r.tour_key === tourFilter);
    }

    if (q) {
      rows = rows.filter(r =>
        (r.comment || '').toLowerCase().includes(q) ||
        (r.user_name || '').toLowerCase().includes(q)
      );
    }

    rows.sort((a, b) => {
      switch (sort) {
        case 'oldest':
          return new Date(a.created_at) - new Date(b.created_at);
        case 'rating_desc':
          return b.stars - a.stars || new Date(b.created_at) - new Date(a.created_at);
        case 'rating_asc':
          return a.stars - b.stars || new Date(b.created_at) - new Date(a.created_at);
        default:
          return new Date(b.created_at) - new Date(a.created_at);
      }
    });

    list.innerHTML = '';

    if (!rows.length) {
      list.innerHTML = '<p class="muted">No reviews found.</p>';
      return;
    }

    for (const r of rows) {
      const who = (r.user_name && r.user_name.trim()) || 'Anonymous';
      const div = document.createElement('div');
      div.className = 'review-card';
      div.innerHTML = `
        <div class="tour-header">
          <h2>${r.title}</h2>
          <div class="stars"><strong>${r.stars}</strong> â˜…</div>
        </div>
        <div class="comment">
          <strong>${who}</strong> â€” ${new Date(r.created_at).toLocaleString()}
          <br>${escapeHtml(r.comment)}
        </div>
      `;
      list.appendChild(div);
    }
  }

  list.addEventListener('click', async (e) => {
  const btn = e.target.closest('.delete-review');
  if (!btn) return;

  const id = btn.dataset.id;
  if (!id) {
    alert("No review id found. Server must return review id.");
    return;
  }

  if (!confirm("Delete this review?")) return;

  try {
    await apiDeleteReview(id);
    cachedReviews = cachedReviews.filter(r => String(r.id) !== String(id));
    renderReviews();
  } catch (err) {
    alert("Failed to delete review.");
    console.error(err);
  }
});

  filterTour.addEventListener('change', renderReviews);
  sortBy.addEventListener('change', renderReviews);
  search.addEventListener('input', renderReviews);

  (async () => {
    cachedReviews = await loadAllReviews();
    renderReviews();
  })();
</script>

</body>
</html>